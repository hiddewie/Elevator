version: v1.0
name: Java
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Gradle
    task:
      jobs:
        - name: Backend
          commands:
            - ./gradlew -v --console=plain
            - ./gradlew build jacocoTestReport --console=plain
      prologue:
        commands:
          - sem-version java 10
          - checkout
          - >-
            curl -LsS
            https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64
            > ./cc-test-reporter
      epilogue:
        on_pass:
          commands:
            - cd src/main/kotlin
            - >-
              ./../../../cc-test-reporter format-coverage
              ../../../build/reports/jacoco/test/jacocoTestReport.xml
              --input-type jacoco --output ../../../coverage/codeclimate.json
            - cd ../../..
            - ./cc-test-reporter upload-coverage
    dependencies: []
  - name: 'Block #2'
    dependencies: []
    task:
      jobs:
        - name: Frontend
          commands:
            - cd web
            - cache restore
            - yarn install
            - cache store
            - yarn build
